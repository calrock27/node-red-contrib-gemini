<script type="text/javascript">
    RED.nodes.registerType('gemini-speech-generate', {
        category: 'AI',
        color: '#9C27B0',
        defaults: {
            name: { value: "" },
            apiKey: { value: "", type: "gemini-api-key", required: true },
            model: { value: "gemini-2.5-flash-preview-tts", required: true },
            text: { value: "" },
            textType: { value: "str" },
            speakerMode: { value: "single" },
            voiceName: { value: "" },
            speaker1Name: { value: "" },
            speaker1Voice: { value: "" },
            speaker2Name: { value: "" },
            speaker2Voice: { value: "" },
            outputFormat: { value: "base64" },
            saveDirectory: { value: "" },
            saveDirType: { value: "str" },
            filename: { value: "" },
            filenameType: { value: "str" },
            systemInstruction: { value: "" },
            systemInstructionType: { value: "str" },
            maxOutputTokens: { value: "" },
            maxOutputTokensType: { value: "num" },
            outputProperty: { value: "payload" },
            passthroughProperties: { value: false }
        },
        inputs: 1,
        outputs: 2,
        outputLabels: ["success", "error"],
        icon: "font-awesome/fa-volume-up",
        label: function() {
            return this.name || "gemini-speech-generate";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var node = this;

            // Initialize TypedInput for text
            $("#node-input-text").typedInput({
                default: 'str',
                types: ['str', 'msg', 'flow', 'global'],
                value: node.text,
                type: node.textType
            });

            // Initialize TypedInput for saveDirectory
            $("#node-input-saveDirectory").typedInput({
                default: 'str',
                types: ['str', 'msg', 'flow', 'global'],
                value: node.saveDirectory,
                type: node.saveDirType
            });

            // Initialize TypedInput for filename
            $("#node-input-filename").typedInput({
                default: 'str',
                types: ['str', 'msg', 'flow', 'global'],
                value: node.filename,
                type: node.filenameType
            });

            // Initialize TypedInput for systemInstruction
            $("#node-input-systemInstruction").typedInput({
                default: 'str',
                types: ['str', 'msg', 'flow', 'global'],
                value: node.systemInstruction,
                type: node.systemInstructionType
            });

            // Initialize TypedInput for maxOutputTokens
            $("#node-input-maxOutputTokens").typedInput({
                default: 'num',
                types: ['num', 'msg', 'flow', 'global'],
                value: node.maxOutputTokens,
                type: node.maxOutputTokensType
            });

            // Show/hide save directory and filename based on output format
            function toggleSaveDirectory() {
                if ($("#node-input-outputFormat").val() === 'file') {
                    $("#save-directory-row").show();
                    $("#filename-row").show();
                    $("#save-directory-row").addClass('required');
                    $("#node-input-saveDirectory").attr('required', true);
                } else {
                    $("#save-directory-row").hide();
                    $("#filename-row").hide();
                    $("#save-directory-row").removeClass('required');
                    $("#node-input-saveDirectory").removeAttr('required');
                }
            }

            // Show/hide speaker configuration based on mode
            function toggleSpeakerMode() {
                const mode = $("#node-input-speakerMode").val();
                if (mode === 'multi') {
                    $("#single-speaker-row").hide();
                    $("#multi-speaker-section").show();
                } else {
                    $("#single-speaker-row").show();
                    $("#multi-speaker-section").hide();
                }
            }

            // Initial states
            toggleSaveDirectory();
            toggleSpeakerMode();

            // Listen for changes
            $("#node-input-outputFormat").change(toggleSaveDirectory);
            $("#node-input-speakerMode").change(toggleSpeakerMode);

            // Advanced configuration collapsible
            $("#advanced-config-header").click(function() {
                $("#advanced-config-content").toggle();
                var icon = $(this).find("i");
                if (icon.hasClass("fa-caret-down")) {
                    icon.removeClass("fa-caret-down").addClass("fa-caret-right");
                } else {
                    icon.removeClass("fa-caret-right").addClass("fa-caret-down");
                }
            });
        },
        oneditsave: function() {
            var node = this;

            // Save TypedInput values and types
            node.text = $("#node-input-text").typedInput('value');
            node.textType = $("#node-input-text").typedInput('type');
            
            node.saveDirectory = $("#node-input-saveDirectory").typedInput('value');
            node.saveDirType = $("#node-input-saveDirectory").typedInput('type');

            node.filename = $("#node-input-filename").typedInput('value');
            node.filenameType = $("#node-input-filename").typedInput('type');

            node.systemInstruction = $("#node-input-systemInstruction").typedInput('value');
            node.systemInstructionType = $("#node-input-systemInstruction").typedInput('type');
            
            node.maxOutputTokens = $("#node-input-maxOutputTokens").typedInput('value');
            node.maxOutputTokensType = $("#node-input-maxOutputTokens").typedInput('type');
            
            node.outputProperty = $("#node-input-outputProperty").val();
        }
    });
</script>

<script type="text/html" data-template-name="gemini-speech-generate">
    <!-- Basic Configuration Section -->
    <div class="form-section">
        <div class="form-section-header">
            <i class="fa fa-cogs"></i> <strong>Basic Configuration</strong>
        </div>
        <div class="form-section-content">
            <div class="form-row">
                <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
                <input type="text" id="node-input-name" placeholder="Name">
            </div>
            
            <div class="form-row required">
                <label for="node-input-apiKey"><i class="fa fa-key"></i> API Key</label>
                <input type="text" id="node-input-apiKey" required>
            </div>
            
            <div class="form-row required">
                <label for="node-input-model"><i class="fa fa-cog"></i> Model</label>
                <input type="text" id="node-input-model" style="width:100%;" placeholder="e.g., gemini-2.5-flash" required>
            </div>
            
            <div class="form-row">
                <label style="width:100%;"><i class="fa fa-external-link"></i> Speech Generation Reference</label>
                <div style="margin-left:10px; font-size:12px; color:#666;">
                    <a href="https://ai.google.dev/gemini-api/docs/speech-generation" target="_blank">View speech generation documentation and voice options</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Content Input Configuration Section -->
    <div class="form-section">
        <div class="form-section-header">
            <i class="fa fa-volume-up"></i> <strong>Content Input Configuration</strong>
        </div>
        <div class="form-section-content">
            <div class="form-row required">
                <label for="node-input-text"><i class="fa fa-comment"></i> Text</label>
                <input type="text" id="node-input-text" style="width:100%;" required>
            </div>
            
            <div class="form-row">
                <label for="node-input-speakerMode"><i class="fa fa-users"></i> Speaker Mode</label>
                <select id="node-input-speakerMode" style="width:200px;">
                    <option value="single">Single Speaker</option>
                    <option value="multi">Multi-Speaker</option>
                </select>
            </div>
            
            <div class="form-row" id="single-speaker-row">
                <label for="node-input-voiceName"><i class="fa fa-microphone"></i> Voice Name</label>
                <input type="text" id="node-input-voiceName" style="width:100%;" placeholder="e.g., Zephyr, Puck, Charon">
                <div style="margin-top:5px; font-size:12px; color:#666;">
                    Use <a href="https://aistudio.google.com/generate-speech" target="_blank">AI Studio</a> to preview voices
                </div>
            </div>
            
            <div id="multi-speaker-section" style="display:none;">
                <div class="form-row">
                    <label style="width:100%; margin-bottom:10px;"><strong>Multi-Speaker Configuration</strong></label>
                </div>

                <div class="form-row">
                    <div style="display:grid; grid-template-columns: 110px 1fr 70px 1fr; gap:10px; align-items:center; width:100%;">
                        <label for="node-input-speaker1Name">Speaker 1 Name:</label>
                        <input type="text" id="node-input-speaker1Name" placeholder="e.g., Alice">
                        <label for="node-input-speaker1Voice">Voice:</label>
                        <input type="text" id="node-input-speaker1Voice" placeholder="e.g., Zephyr">
                    </div>
                </div>

                <div class="form-row">
                    <div style="display:grid; grid-template-columns: 110px 1fr 70px 1fr; gap:10px; align-items:center; width:100%;">
                        <label for="node-input-speaker2Name">Speaker 2 Name:</label>
                        <input type="text" id="node-input-speaker2Name" placeholder="e.g., Bob">
                        <label for="node-input-speaker2Voice">Voice:</label>
                        <input type="text" id="node-input-speaker2Voice" placeholder="e.g., Puck">
                    </div>
                </div>

                <div class="form-row">
                    <div style="margin-left:10px; font-size:12px; color:#666;">
                        <strong>Note:</strong> Your text should specify speaker names (e.g., "Alice: Hello! Bob: Hi there!")
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Output Configuration Section -->
    <div class="form-section">
        <div class="form-section-header">
            <i class="fa fa-sign-out"></i> <strong>Output Configuration</strong>
        </div>
        <div class="form-section-content">
            <div class="form-row">
                <label for="node-input-outputFormat"><i class="fa fa-file-audio-o"></i> Output Format</label>
                <select id="node-input-outputFormat" style="width:200px;">
                    <option value="base64">Base64 String</option>
                    <option value="buffer">Buffer</option>
                    <option value="url">Data URL</option>
                    <option value="file">Save to File</option>
                </select>
            </div>
            
            <div class="form-row" id="save-directory-row" style="display:none;">
                <label for="node-input-saveDirectory"><i class="fa fa-folder"></i> Save Directory</label>
                <input type="text" id="node-input-saveDirectory" style="width:100%;" placeholder="e.g., /home/user/audio">
                <div style="margin-top:5px; font-size:12px; color:#666;">
                    Leave blank to use Node-RED user directory (~/.node-red/). Directory will be created if it doesn't exist.
                </div>
            </div>

            <div class="form-row" id="filename-row" style="display:none;">
                <label for="node-input-filename"><i class="fa fa-file-audio-o"></i> Filename</label>
                <input type="text" id="node-input-filename" style="width:100%;" placeholder="e.g., my_audio.wav or {{msg.audioName}}">
                <div style="margin-top:5px; font-size:12px; color:#666;">
                    Leave blank for auto-generated timestamp filename. File extension (.wav) will be added automatically if not present.
                </div>
            </div>

            <div class="form-row">
                <label for="node-input-outputProperty"><i class="fa fa-sign-out"></i> Output Property</label>
                <input type="text" id="node-input-outputProperty" style="width:200px;" placeholder="payload">
                <div style="margin-top:5px; font-size:12px; color:#666;">
                    Message property to store the generated audio. Default is "payload".
                </div>
            </div>

            <div class="form-row">
                <label for="node-input-passthroughProperties" style="width:auto;">
                    <input type="checkbox" id="node-input-passthroughProperties" style="display:inline-block; width:auto; vertical-align:middle; margin:0 5px 0 0;">
                    <span style="vertical-align:middle;">Passthrough Additional Properties</span>
                </label>
                <div style="margin-top:5px; margin-left:20px; font-size:12px; color:#666;">
                    Controls what properties are sent to downstream nodes. When <strong>disabled</strong> (default), only the configured output property is sent, creating a clean message. When <strong>enabled</strong>, all incoming message properties pass through to downstream nodes along with the output.
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Configuration Section -->
    <div class="form-section">
        <div class="form-section-header-collapsible" id="advanced-config-header">
            <i class="fa fa-caret-right"></i> <strong>Advanced Configuration</strong>
        </div>
        <div class="form-section-content-collapsible" id="advanced-config-content" style="display:none;">
            <div class="form-row">
                <label for="node-input-systemInstruction"><i class="fa fa-user-circle"></i> System Instruction</label>
                <input type="text" id="node-input-systemInstruction" style="width:100%;">
                <div style="margin-top:5px; font-size:12px; color:#666;">
                    Set model persona, role, or context (e.g., "You are a professional narrator", "Use an enthusiastic tone")
                </div>
            </div>
            
            <div class="form-row">
                <label for="node-input-maxOutputTokens"><i class="fa fa-text-width"></i> Max Output Tokens</label>
                <input type="text" id="node-input-maxOutputTokens" style="width:200px;">
                <span style="margin-left:10px; color:#666;">Maximum response length</span>
            </div>
        </div>
    </div>
    
    <div class="form-tips">
        <p><strong>Tips:</strong></p>
        <ul>
            <li>Use clear, well-punctuated text for best speech quality</li>
            <li>For multi-speaker, format text as "Speaker1: Text. Speaker2: Text."</li>
            <li>Preview voices using AI Studio before implementation</li>
            <li>Base64 output is most compatible with Node-RED flows</li>
            <li>Buffer format is useful for direct audio processing</li>
        </ul>
    </div>
    
    <style>
        .form-section {
            margin-bottom: 20px;
        }
        .form-section-header {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px 4px 0 0;
            padding: 8px 12px;
            font-weight: bold;
            color: #495057;
            border-bottom: none;
        }
        .form-section-header-collapsible {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px 12px;
            font-weight: bold;
            color: #495057;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .form-section-header-collapsible:hover {
            background: #e9ecef;
        }
        .form-section-content {
            border: 1px solid #dee2e6;
            border-radius: 0 0 4px 4px;
            padding: 15px;
            background: #ffffff;
        }
        .form-section-content-collapsible {
            padding: 15px;
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .form-section .form-row:last-child {
            margin-bottom: 0;
        }
        
        /* Required Field Styling */
        .form-row.required label::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }
        
        .form-row.required input,
        .form-row.required select {
            border-left: 3px solid #dc3545;
        }
        
        .form-row.required input:valid,
        .form-row.required select:valid {
            border-left-color: #28a745;
        }
        
        .form-row.required input[type="text"]:not(:placeholder-shown),
        .form-row.required select:not([value=""]) {
            border-left-color: #28a745;
        }
    </style>
</script>

<script type="text/html" data-help-name="gemini-speech-generate">
    <p>Generate speech/audio from text using Google's Gemini AI speech generation capabilities. Supports both single-speaker and multi-speaker configurations.</p>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>API Key <span class="property-type">gemini-api-key</span></dt>
        <dd>Reference to a Gemini API Key configuration node</dd>
        
        <dt>Model <span class="property-type">string</span></dt>
        <dd>The speech generation model to use (e.g., gemini-2.5-flash, gemini-2.5-pro). Can be overridden via <code>msg.model</code></dd>
        
        <dt>Text <span class="property-type">string</span></dt>
        <dd>Text content to convert to speech. Supports TypedInput for dynamic content from message properties</dd>
        
        <dt>Speaker Mode <span class="property-type">string</span></dt>
        <dd>
            <ul>
                <li><strong>Single Speaker:</strong> Uses one voice for all text</li>
                <li><strong>Multi-Speaker:</strong> Supports up to 2 different speakers with distinct voices</li>
            </ul>
        </dd>
        
        <dt>Voice Name <span class="property-type">string</span></dt>
        <dd>Voice name for single-speaker mode (e.g., Zephyr, Puck, Charon). Preview voices at <a href="https://aistudio.google.com/generate-speech" target="_blank">AI Studio</a></dd>
        
        <dt>Multi-Speaker Configuration <span class="property-type">object</span></dt>
        <dd>For multi-speaker mode:
            <ul>
                <li><strong>Speaker Names:</strong> Identifiers used in the text</li>
                <li><strong>Voice Names:</strong> Voice assigned to each speaker</li>
                <li><strong>Text Format:</strong> "Speaker1: Text. Speaker2: Text."</li>
            </ul>
        </dd>
        
        <dt>Output Format <span class="property-type">string</span></dt>
        <dd>Format of the generated audio:
            <ul>
                <li><strong>Base64 String:</strong> Text representation for easy handling</li>
                <li><strong>Buffer:</strong> Binary data for audio processing</li>
                <li><strong>Data URL:</strong> data:audio/wav;base64,... format</li>
                <li><strong>Save to File:</strong> Saves audio to disk and returns file path</li>
            </ul>
        </dd>
        
        <dt>Save Directory <span class="property-type">string</span></dt>
        <dd>Directory path for saving audio files (only when Output Format is "Save to File"):
            <ul>
                <li>Leave blank to use Node-RED user directory</li>
                <li>Supports TypedInput for dynamic paths</li>
                <li>Directory will be created automatically if it doesn't exist</li>
                <li>Can be overridden via <code>msg.saveDirectory</code></li>
            </ul>
        </dd>
        
        <dt>Output Property <span class="property-type">string</span></dt>
        <dd>Message property name to store the generated audio:
            <ul>
                <li>Default is "payload" if left blank</li>
                <li>Can be any valid message property name</li>
                <li>Useful for preserving existing payload data</li>
            </ul>
        </dd>
    </dl>
    
    <h3>Advanced Configuration</h3>
    <dl class="message-properties">
        <dt>System Instruction <span class="property-type">string</span></dt>
        <dd>Set model persona, role, or context to guide speech generation behavior:
            <ul>
                <li>"You are a professional narrator" - Professional narration role</li>
                <li>"Use an enthusiastic tone" - Specific tone guidance</li>
                <li>"Read as a news anchor" - Specific reading style</li>
                <li>Supports TypedInput for dynamic instructions</li>
            </ul>
        </dd>
        
        <dt>Max Output Tokens <span class="property-type">number</span></dt>
        <dd>Maximum length of generated response</dd>
    </dl>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string</span></dt>
        <dd>Text content for speech generation (if not configured in node)</dd>
        
        <dt>model <span class="property-type">string</span></dt>
        <dd>Override configured model</dd>
        
        <dt>voiceName <span class="property-type">string</span></dt>
        <dd>Override configured voice name (single-speaker mode)</dd>
        
        <dt>saveDirectory <span class="property-type">string</span></dt>
        <dd>Override configured save directory (when using file output format)</dd>
        
        <dt>systemInstruction <span class="property-type">string</span></dt>
        <dd>Override configured system instruction</dd>
        
        <dt>maxOutputTokens <span class="property-type">number</span></dt>
        <dd>Override configured max output tokens</dd>
    </dl>
    
    <h3>Outputs</h3>
    <h4>Output 1 (Success)</h4>
    <dl class="message-properties">
        <dt>[outputProperty] <span class="property-type">string | Buffer</span></dt>
        <dd>Generated audio in the specified output format stored in the configured output property (default: payload). When using "Save to File", contains file path</dd>
        
        <dt>model <span class="property-type">string</span></dt>
        <dd>Model used for generation</dd>
        
        <dt>text <span class="property-type">string</span></dt>
        <dd>The text that was converted to speech</dd>
        
        <dt>voiceConfig <span class="property-type">string</span></dt>
        <dd>Voice configuration used (voice name or "multi-speaker")</dd>
        
        <dt>speakerMode <span class="property-type">string</span></dt>
        <dd>Speaker mode used ("single" or "multi")</dd>
        
        <dt>outputFormat <span class="property-type">string</span></dt>
        <dd>Format of the returned audio</dd>
        
        <dt>usage <span class="property-type">object</span></dt>
        <dd>Token usage statistics</dd>
    </dl>
    
    <h4>Output 2 (Error)</h4>
    <dl class="message-properties">
        <dt>payload <span class="property-type">any</span></dt>
        <dd>Original message payload</dd>
        
        <dt>error <span class="property-type">object</span></dt>
        <dd>Error details including message and code</dd>
    </dl>
    
    <h3>Examples</h3>
    
    <h4>Simple Single-Speaker Speech</h4>
    <pre>[{"id":"example1","type":"gemini-speech-generate","name":"Simple Speech","apiKey":"your-api-key","model":"gemini-2.5-flash","text":"Hello, welcome to our speech generation demo!","voiceName":"Zephyr","speakerMode":"single","outputFormat":"base64","x":100,"y":100,"wires":[[],[]]}]</pre>
    
    <h4>Multi-Speaker Conversation</h4>
    <pre>[{"id":"example2","type":"inject","name":"Multi-Speaker","props":[{"p":"payload","v":"Alice: Good morning! How are you today? Bob: I'm doing great, thanks for asking!","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":100,"y":200,"wires":[["example3"]]},{"id":"example3","type":"gemini-speech-generate","name":"Conversation","apiKey":"your-api-key","model":"gemini-2.5-flash","textType":"msg","text":"payload","speakerMode":"multi","speaker1Name":"Alice","speaker1Voice":"Zephyr","speaker2Name":"Bob","speaker2Voice":"Puck","outputFormat":"buffer","x":300,"y":200,"wires":[[],[]]}]</pre>
    
    <h4>Save Audio to File</h4>
    <pre>[{"id":"example4","type":"gemini-speech-generate","name":"Save Audio","apiKey":"your-api-key","model":"gemini-2.5-pro","text":"This audio will be saved to a file for later use.","voiceName":"Charon","speakerMode":"single","outputFormat":"file","saveDirectory":"/home/user/audio","outputProperty":"audioFile","x":100,"y":300,"wires":[[],[]]}]</pre>
    
    <h4>Dynamic Voice Selection</h4>
    <pre>[{"id":"example5","type":"inject","name":"Dynamic Voice","props":[{"p":"payload","v":"This text will use a dynamically selected voice.","vt":"str"},{"p":"voiceName","v":"Fenrir","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":100,"y":400,"wires":[["example6"]]},{"id":"example6","type":"gemini-speech-generate","name":"Dynamic Speech","apiKey":"your-api-key","model":"gemini-2.5-flash","textType":"msg","text":"payload","speakerMode":"single","outputFormat":"url","x":300,"y":400,"wires":[[],[]]}]</pre>
    
    <h3>Voice Options</h3>
    <p>Popular voice names include:</p>
    <ul>
        <li><strong>Zephyr:</strong> Bright, upbeat style</li>
        <li><strong>Puck:</strong> Informative, clear delivery</li>
        <li><strong>Charon:</strong> Firm, authoritative tone</li>
        <li><strong>Kore:</strong> Excitable, energetic style</li>
        <li><strong>Fenrir:</strong> Deep, resonant voice</li>
    </ul>
    
    <h3>Multi-Speaker Format</h3>
    <p>For multi-speaker content, format your text as:</p>
    <pre>Alice: Hello there! How are you doing today?
Bob: I'm doing great, thanks for asking! How about you?
Alice: Wonderful! I'm excited about this new project.</pre>
    
    <h3>Tips</h3>
    <ul>
        <li><strong>Text Quality:</strong> Use clear punctuation and proper grammar for best results</li>
        <li><strong>Voice Preview:</strong> Test voices using <a href="https://aistudio.google.com/generate-speech" target="_blank">AI Studio</a> before implementation</li>
        <li><strong>Speaker Names:</strong> Ensure speaker names in text match configured speaker names exactly</li>
        <li><strong>File Output:</strong> Use "Save to File" for persistent audio storage</li>
        <li><strong>Buffer Format:</strong> Use Buffer output for direct audio processing or streaming</li>
        <li><strong>Language Support:</strong> API supports 24 languages with automatic detection</li>
        <li><strong>Context Limits:</strong> Maximum 32k token context window for text input</li>
    </ul>
    
    <p><strong>Reference:</strong> <a href="https://ai.google.dev/gemini-api/docs/speech-generation" target="_blank">Gemini API Speech Generation Documentation</a></p>
</script>